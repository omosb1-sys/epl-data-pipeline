
import os
import time
import feedparser
from datetime import datetime
from google import genai

# 1. ì„¤ì •
RSS_URL = "https://cdn.aitimes.com/rss/gn_rss_allArticle.xml"
SAVE_DIR = "research/readings/ai_times_trends"
os.makedirs(SAVE_DIR, exist_ok=True)

api_key = os.environ.get("GEMINI_API_KEY")

def get_ai_wisdom(title, desc):
    """AI Times ê¸°ì‚¬ë¥¼ ë¶„ì„í•˜ì—¬ Antigravity í”„ë¡œì íŠ¸ ì ìš©ì  ë„ì¶œ (Gemini 3)"""
    if not api_key:
        return "ğŸ’¡ ë¶„ì„ ëŒ€ê¸°: API Key ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."
    
    try:
        client = genai.Client(api_key=api_key)
        prompt = f"""
        ë‹¹ì‹ ì€ 'Antigravity' í”„ë¡œì íŠ¸ì˜ ì‹œë‹ˆì–´ ë°ì´í„° ë¶„ì„ê°€ì…ë‹ˆë‹¤. 
        ì¶•êµ¬ ë°ì´í„°(EPL/K-League) ë¶„ì„ ë° AI ì—ì´ì „íŠ¸ ê°œë°œ ê´€ì ì—ì„œ ë‹¤ìŒ ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ì„¸ìš”.
        
        [ë‰´ìŠ¤ ì œëª©]: {title}
        [ë‰´ìŠ¤ ìš”ì•½]: {desc[:600]}
        
        [ë¯¸ì…˜]:
        ì´ ë‰´ìŠ¤ê°€ ìš°ë¦¬ì˜ ë°ì´í„° íŒŒì´í”„ë¼ì¸, ì˜ˆì¸¡ ëª¨ë¸(DLinear ë“±), ë˜ëŠ” ì‚¬ìš©ì UI/UXì— ì¤„ ìˆ˜ ìˆëŠ” 
        'êµ¬ì²´ì ì¸ ì˜ê°'ì´ë‚˜ 'ê¸°ìˆ ì  ì ìš©ì 'ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ë„ì¶œí•˜ì„¸ìš”.
        """
        
        response = client.models.generate_content(
            model='gemini-3-flash-preview',
            contents=prompt
        )
        return response.text.replace('\n', ' ').strip()
    except Exception as e:
        return f"ë¶„ì„ ì¼ì‹œ ì¤‘ë‹¨... ({str(e)[:50]})"

def analyze_and_report(post):
    print(f"   â†³ ğŸ§  AI ë¶„ì„ ì¤‘... ", end=" ", flush=True)
    wisdom = get_ai_wisdom(post.title, post.summary if hasattr(post, 'summary') else post.description)
    print("âœ…")
    return f"### {post.title}\n\n**Data Analyst Insight:**\n{wisdom}\n\n**Link**: {post.link}"

def main():
    print("ğŸ“° AI Times Knowledge Harvester (Next-Gen Engine)")
    feed = feedparser.parse(RSS_URL)
    
    # ìµœì‹  ë‰´ìŠ¤ 8ê°œ ë¶„ì„
    posts = feed.entries[:8]
    today_str = datetime.now().strftime("%Y-%m-%d")
    
    results = []
    for i, post in enumerate(posts):
        print(f"[{i+1}/{len(posts)}] {post.title[:45]}...")
        results.append(analyze_and_report(post))
        time.sleep(0.5) # API ì†ë„ ì¡°ì ˆ
        
    report_path = os.path.join(SAVE_DIR, f"aitimes_digest_{today_str}.md")
    with open(report_path, "w", encoding='utf-8') as f:
        f.write(f"# AI Times Daily Intelligence ({today_str})\n\n" + "\n\n".join(results))
        f.write(f"\n\n---\n*Generated by Antigravity Senior Analyst System (v3.0)*")
        
    print(f"\nâœ¨ AI Times ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: {report_path}")

if __name__ == "__main__":
    main()
